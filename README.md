## RSNA Intracranial Hemorrhage Detection

#### Description
Intracranial hemorrhage, bleeding that occurs inside the cranium, is a serious health problem requiring rapid and often intensive medical treatment. For example, intracranial hemorrhages account for approximately 10% of strokes in the U.S., where stroke is the fifth-leading cause of death. Identifying the location and type of any hemorrhage present is a critical step in treating the patient.

Diagnosis requires an urgent procedure. When a patient shows acute neurological symptoms such as severe headache or loss of consciousness, highly trained specialists review medical images of the patient’s cranium to look for the presence, location and type of hemorrhage. The process is complicated and often time consuming.

[More info here](https://www.kaggle.com/c/rsna-intracranial-hemorrhage-detection/overview)

#### Evaluation
Submissions are evaluated using a weighted multi-label logarithmic loss. Each hemorrhage sub-type is its own row for every image, and you are expected to predict a probability for that sub-type of hemorrhage. There is also an any label, which indicates that a hemorrhage of ANY kind exists in the image. Theany label is weighted more highly than specific hemorrhage sub-types.

For each image Id, you must submit a set of predicted probabilities (a separate row for each sub-type). We then take the log loss for each predicted probability versus its true label. Finally, loss is averaged across all samples.

- [More info here](https://www.kaggle.com/c/rsna-intracranial-hemorrhage-detection/overview/evaluation)
- [LB probe is complete](https://www.kaggle.com/c/rsna-intracranial-hemorrhage-detection/discussion/110461)

#### Preprocessing

#### Transformations

**Train**
```python
import albumentations as A
import os

DIR_PROJECT = os.path.dirname(os.path.realpath(__file__))
DIR_TRANSFORMS = DIR_PROJECT + '/transforms'

transform = A.Compose([
    A.HorizontalFlip(),
    A.ShiftScaleRotate(scale_limit=0.08, rotate_limit=0, p=.75),
    A.Rotate(limit=15, p=0.75),
    A.CoarseDropout(max_holes=8, max_height=16, max_width=16, min_holes=4, min_height=8, min_width=8),
    A.Normalize(mean=(0.27176, 0.26492, 0.46473), std=(0.35144, 0.29973, 0.23607), p=1.0)
])

A.save(transform, DIR_TRANSFORMS + '/train_intermediate.json')
print(transform)
exit(0)

```

**Complex**
```python
import albumentations as A
import os
from common.albumentations import DicomWindowShift

DIR_PROJECT = os.path.dirname(os.path.realpath(__file__))
DIR_TRANSFORMS = DIR_PROJECT + '/transforms'

transform = A.Compose([
    DicomWindowShift(window_width_mins=(80, 200, 380),
                     window_width_maxs=(80, 200, 380),
                     window_center_mins=(40, 80, 40),
                     window_center_maxs=(40, 80, 40),
                     p=1.0),
    A.RandomResizedCrop(height=512, width=512, scale=(0.7, 1.0), p=1.0),
    A.HorizontalFlip(),
    A.ShiftScaleRotate(shift_limit=0.125, scale_limit=0, rotate_limit=0, p=.6),
    A.Rotate(limit=30, p=0.75),
    A.GridDistortion(),
    A.CoarseDropout(max_holes=8, max_height=16, max_width=16, min_holes=4, min_height=8, min_width=8),
    A.GaussNoise(),
])

A.save(transform, DIR_TRANSFORMS + '/train_complex_512.json')
print(transform)
exit(0)
```

**TTA**
```python
import albumentations as A
import os

DIR_PROJECT = os.path.dirname(os.path.realpath(__file__))
DIR_TRANSFORMS = DIR_PROJECT + '/transforms'

transform = A.Compose([
    A.RandomResizedCrop(height=512, width=512, scale=(0.7, 1.0), p=1.0),
    A.HorizontalFlip(),
    A.Rotate(limit=30, p=0.75),
    A.GridDistortion(),
])

A.save(transform, DIR_TRANSFORMS + '/test_intermediate_tta_512.json')
print(transform)
exit(0)
```

#### Final model

### Code
*For more details see the README.md files in the subfolders.*
```
RSNAHemorrhage/
  |- common/
  |- input/
  |- notebooks/
  |- output/
  |    | - results/
  |    |     |- [experiment_id]/
  |- .gitignore
  |- config.py
  |- preprocessing.py
  |- README.md
  |- requirements.txt
  |- rsna_dataset.py
  |- rsna_model.py
  |- rsna_network.py
  |- train.py
  |- train.sh
```

- `common/` - General, reusable codes.
- `input/` - Input foloders/files: train and test images (folder); train/test .csv, sample submission file,
preprocessed images, etc.
- `notebooks/` - Jupyter notebooks
- `output/` - Files and folders generated by scripts. Image stats, logs, experiment outputs, etc.
- `output/[experiment_id]/` - output directory for specific experiments
- `.gitignore` - Git ignore file
- `preprocess.py` - Preprocessing script for converting dicom to numpy array (resize, normalize, etc).
- `README.md` - This README file
- `requirements.txt` - Python requirements
- `rsna_dataset` - Custom dataset for RSNA competition
- `rsna_model` - Custom models for RSNA competition
- `rsna_network` - Custom network for RSNA competition
- `train.py` - Main script for training
- `train.sh` - Bash for execute trainings

#### Train
`train.sh`, `train.py`
Csak a szükséges osztályok létrehozását (log, network, model, optimizer, stb) és a train (.fit) futtatását tartalmazza.
A train fő folyamatát a `common.networks.network.AbstractNetwork` osztályban találod `def fit(...)`

##### Config paraméterek
**Általános**
- --experiment_id - Experiment azonosító. Ha nincs megadva, magától ad egy folyamatosan növekvő számot
- --seed - Random seed
- --dev_enabled - Fejlesztői mód engedélyezve (Nem küld neptune üzeneteket, consolra logol, nem tölti be a teljes adathalmazt, stb)
- --n_jobs - Rendelkezésre álló CPU core-ok száma
- --output_dir - Kimeneti mappa (./output/results/...experiment_id...)

**Adatok**
- --data_dataset - Használt dataset (input/datsets/{x})
- --data_fold - Haszánlt fold azonostíó (inputs/datasets/{x}/dataset_{x}\_fold_{y})
- --data_input_folder - Input mappa (./input)
- --data_train_transform - Albumentation train transofrm file (pl: ./transforms/train_transform.json)
- --data_valid_transform - Albumentation valid transofrm file (pl: ./transforms/valid_transform.json)
- --data_sampler - Sampler adatbetöltéshez (nem működik)

**Hálózat, model**
- --net_model - Model azonosító (Jelenleg egy teszt model van bekódolva, de később ez konfigolható lesz)
- --net_pretrained - Alap modelhez (resnet, densenet, stb) ImageNet súlyok betöltése (ha --net_weights_file) is meg van
adva, akkor ennek nincs jelentősége
- --net_weight_file - Saját (pytorch) weight file (még nem működik)

**Optimizer**
- Még nem működnek

**Train**
- --tr_use_amp - APEX használat (nem teszteltem)
- --tr_iteration_num - Train iteration szám (1 epoch = #num of samples // batch_size)
- --tr_batch_size - Batch méret
- --tr_accumulation_step - Loss backward futtatás x batch után
- --tr_iteration_valid - Validation futtatás x iteration után

**Egyéb**
- --nml_enabled Neptune.ml monitorozás engedélyezése



#### Evaluate

#### Ensemble